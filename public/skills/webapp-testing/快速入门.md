# webapp-testing 技能快速入门指南

## 简介

webapp-testing 是一个基于 Playwright 的 Web 应用测试工具包，可以帮助你自动化测试前端页面。

## 安装步骤

### 1. 安装 Playwright

```bash
# 安装 Python 包
pip install playwright

# 安装浏览器驱动（首次使用必须执行）
playwright install chromium
```

### 2. 验证安装

```bash
# 测试 Playwright 是否安装成功
python -c "from playwright.sync_api import sync_playwright; print('Playwright 安装成功')"
```

## 使用场景

### 场景 1: 测试静态 HTML 页面

适用于：本地 HTML 文件，无需启动服务器

```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()

    # 打开本地 HTML 文件
    page.goto('file:///C:/path/to/your/index.html')
    page.wait_for_load_state('networkidle')

    # 截图
    page.screenshot(path='screenshot.png', full_page=True)

    # 检查页面内容
    title = page.title()
    print(f"页面标题: {title}")

    browser.close()
```

### 场景 2: 测试已运行的开发服务器

适用于：服务器已经在运行（如 `npm run dev` 已启动）

```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()

    # 访问本地开发服务器
    page.goto('http://localhost:3000')
    page.wait_for_load_state('networkidle')  # 关键：等待页面加载完成

    # 查找页面元素
    buttons = page.locator('button').all()
    print(f"找到 {len(buttons)} 个按钮")

    # 点击按钮
    page.click('text=登录')

    # 填写表单
    page.fill('input[name="username"]', 'testuser')
    page.fill('input[name="password"]', 'password123')

    # 提交表单
    page.click('button[type="submit"]')

    # 等待跳转
    page.wait_for_url('**/dashboard')

    # 验证结果
    assert page.locator('text=欢迎').is_visible()

    browser.close()
```

### 场景 3: 自动启动服务器并测试

适用于：需要自动启动和停止服务器

**步骤 1：创建测试脚本** `test_my_app.py`

```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()

    # 访问页面（服务器已由 with_server.py 启动）
    page.goto('http://localhost:5173')
    page.wait_for_load_state('networkidle')

    # 你的测试逻辑
    print("页面标题:", page.title())

    # 截图
    page.screenshot(path='test_result.png', full_page=True)

    browser.close()
```

**步骤 2：使用 with_server.py 运行测试**

```bash
# 单个服务器
python C:\Users\lirun\.claude\skills\webapp-testing\scripts\with_server.py \
  --server "npm run dev" \
  --port 5173 \
  -- python test_my_app.py

# 多个服务器（前后端分离）
python C:\Users\lirun\.claude\skills\webapp-testing\scripts\with_server.py \
  --server "cd backend && python server.py" --port 3000 \
  --server "cd frontend && npm run dev" --port 5173 \
  -- python test_my_app.py
```

## 常用操作

### 1. 查找元素

```python
# 通过文本查找
page.locator('text=登录')

# 通过 CSS 选择器
page.locator('button.submit')

# 通过 ID
page.locator('#login-button')

# 通过属性
page.locator('input[name="username"]')

# 通过角色
page.locator('role=button[name="提交"]')

# 查找所有匹配的元素
buttons = page.locator('button').all()
```

### 2. 交互操作

```python
# 点击
page.click('button.submit')

# 填写输入框
page.fill('input[name="email"]', 'test@example.com')

# 选择下拉框
page.select_option('select[name="country"]', 'China')

# 勾选复选框
page.check('input[type="checkbox"]')

# 取消勾选
page.uncheck('input[type="checkbox"]')

# 上传文件
page.set_input_files('input[type="file"]', 'path/to/file.pdf')
```

### 3. 等待和断言

```python
# 等待元素出现
page.wait_for_selector('button.submit')

# 等待元素消失
page.wait_for_selector('div.loading', state='hidden')

# 等待 URL 变化
page.wait_for_url('**/dashboard')

# 等待网络空闲
page.wait_for_load_state('networkidle')

# 等待固定时间（不推荐，尽量使用上面的方法）
page.wait_for_timeout(1000)  # 1秒

# 断言元素可见
assert page.locator('text=欢迎').is_visible()

# 断言元素包含文本
assert '成功' in page.locator('.message').inner_text()
```

### 4. 截图和调试

```python
# 整页截图
page.screenshot(path='full_page.png', full_page=True)

# 可视区域截图
page.screenshot(path='viewport.png')

# 元素截图
page.locator('div.card').screenshot(path='card.png')

# 获取页面 HTML
html = page.content()

# 获取元素文本
text = page.locator('h1').inner_text()

# 获取元素属性
href = page.locator('a').get_attribute('href')
```

### 5. 捕获控制台日志

```python
console_logs = []

def handle_console(msg):
    console_logs.append(f"[{msg.type}] {msg.text}")
    print(f"控制台: [{msg.type}] {msg.text}")

page.on("console", handle_console)

# 之后的操作会捕获控制台输出
page.goto('http://localhost:3000')
```

## 完整测试示例

```python
from playwright.sync_api import sync_playwright

def test_login_flow():
    """测试登录流程"""
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()

        try:
            # 1. 访问登录页
            print("1. 访问登录页...")
            page.goto('http://localhost:3000/login')
            page.wait_for_load_state('networkidle')

            # 2. 填写表单
            print("2. 填写登录表单...")
            page.fill('input[name="username"]', 'testuser')
            page.fill('input[name="password"]', 'password123')

            # 3. 提交表单
            print("3. 提交表单...")
            page.click('button[type="submit"]')

            # 4. 等待跳转
            print("4. 等待跳转到仪表板...")
            page.wait_for_url('**/dashboard', timeout=5000)

            # 5. 验证登录成功
            print("5. 验证登录状态...")
            welcome = page.locator('text=/欢迎|Welcome/i')
            assert welcome.is_visible(), "未找到欢迎消息"

            # 6. 截图保存结果
            page.screenshot(path='login_success.png')

            print("✓ 登录测试通过")
            return True

        except Exception as e:
            print(f"✗ 测试失败: {e}")
            page.screenshot(path='login_failed.png')
            return False

        finally:
            browser.close()

if __name__ == '__main__':
    success = test_login_flow()
    exit(0 if success else 1)
```

## 示例脚本

技能包含以下中文示例脚本：

1. **element_discovery_cn.py** - 发现页面元素（按钮、链接、输入框）
2. **navigation_testing_cn.py** - 测试页面导航和路由
3. **form_testing_cn.py** - 测试表单填写和提交
4. **console_logging_cn.py** - 捕获浏览器控制台日志

运行示例：
```bash
cd C:\Users\lirun\.claude\skills\webapp-testing\examples
python element_discovery_cn.py
```

## 故障排除

### 问题 1: ModuleNotFoundError: No module named 'playwright'

**解决方案：**
```bash
pip install playwright
playwright install chromium
```

### 问题 2: 元素未找到 (Element not found)

**原因：** 页面还未加载完成就开始查找元素

**解决方案：**
```python
# 确保等待页面加载完成
page.wait_for_load_state('networkidle')

# 或者等待特定元素出现
page.wait_for_selector('button.submit')
```

### 问题 3: 服务器未启动

**原因：** 端口被占用或启动超时

**解决方案：**
```bash
# 检查端口是否被占用
netstat -ano | findstr :3000

# 增加超时时间
python scripts/with_server.py --server "npm run dev" --port 3000 --timeout 60 -- python test.py
```

### 问题 4: 测试不稳定，时而成功时而失败

**原因：** 使用了固定延迟而不是等待条件

**解决方案：**
```python
# ❌ 不好的做法
page.click('button')
page.wait_for_timeout(2000)  # 固定等待 2 秒

# ✅ 好的做法
page.click('button')
page.wait_for_selector('.result')  # 等待结果出现
```

## 下一步

1. 查看 `SKILL_CN.md` 了解更多高级用法
2. 运行示例脚本熟悉 API
3. 根据你的项目编写自定义测试脚本
4. 集成到 CI/CD 流程中实现自动化测试

## 获取帮助

- 查看 Playwright 官方文档: https://playwright.dev/python/
- 运行脚本时使用 `--help` 查看用法
- 查看示例脚本了解常见模式
